#!/bin/bash
set -uo pipefail

# =========================================================
# SinNombre v2.0 - Panel CLI (Ubuntu 22.04+)
# Creador: @SIN_NOMBRE22
# =========================================================

R='\033[0;31m'
G='\033[0;32m'
Y='\033[1;33m'
B='\033[0;34m'
M='\033[0;35m'
C='\033[0;36m'
W='\033[1;37m'
N='\033[0m'
BOLD='\033[1m'
#=====≠===============================================
#Colores del banner
ROJO="\e[31m"
BLANCO="\e[97m"
CYAN="\e[36m"
AMARILLO="\e[33m"
RESET="\e[0m"
#=====================================================
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ============================
# Licencia (runtime check)
# ============================
# ============================
# Licencia (runtime check) - LOCAL + BYPASS DEV IP
# ============================
LIC_DIR="/etc/.sn"
LIC_PATH="${LIC_DIR}/lic"

# BYPASS solo para tu VPS (tu IP pública)
MY_DEV_IP="74.208.112.115"

license_box() {
  clear
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}${BOLD}LICENCIA NO VÁLIDA / NO ENCONTRADA${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo ""
  echo -e "${W}Este servidor no está activado.${N}"
  echo -e "${W}Ejecuta el instalador e ingresa una key válida.${N}"
  echo ""
  exit 1
}

get_public_ip() {
  # intenta varias fuentes; si falla retorna vacío
  curl -fsS --max-time 2 https://api.ipify.org 2>/dev/null || true
}

check_license() {
  # 0) BYPASS SOLO si detecta IP y coincide EXACTA
  MY_IP="$(get_public_ip)"
  if [[ -n "$MY_IP" && "$MY_IP" == "$MY_DEV_IP" ]]; then
    return 0
  fi

  # 1) Licencia local (marca creada por install.sh tras consumir key)
  [[ -f "$LIC_PATH" ]] || license_box
}

check_license
#________________________________________
#________________________________________
run_module() {
  local rel="$1"
  local path="${ROOT_DIR}/${rel}"
  if [[ -f "$path" ]]; then
    bash "$path"
    # Cuando el módulo termina, limpia la pantalla y retorna
    clear_screen
  else
    echo ""
    echo -e "${Y}Módulo no disponible:${N} ${C}${rel}${N}"
    echo -e "${Y}Estado:${N} En desarrollo..."
    pause
  fi
}

clear_screen() { clear; }

pause() {
  echo ""
  read -r -p "Presiona Enter para continuar..."
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    clear_screen
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo -e "${Y}Este panel debe ejecutarse como root.${N}"
    echo -e "${W}Usa:${N} ${C}sudo menu${N}  ${W}o${N}  ${C}sudo sn${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    exit 1
  fi
}

show_custom_banner() {
  if command -v toilet &>/dev/null; then
    echo -e "\e[31m$(toilet -f slant -F metal "SinNombre")\e[0m"
  fi
}

get_system_info() {
  if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    DISTRO="${PRETTY_NAME:-$(uname -rs)}"
  else
    DISTRO="$(uname -rs)"
  fi

  IP_PUBLICA="$(
    curl -fsS --max-time 2 ifconfig.me 2>/dev/null \
    || curl -fsS --max-time 2 ipinfo.io/ip 2>/dev/null \
    || echo "No disponible"
  )"

  USUARIO="$(whoami)"
  ZONA_HORARIA="$(timedatectl 2>/dev/null | awk -F': ' '/Time zone/ {print $2}' | awk '{print $1}' || date +%Z)"

  read MEM_TOTAL MEM_USADA MEM_LIBRE <<< $(free -m | awk '/^Mem:/ {print $2, $3, $7}')

  # Verificar dominio
  DOMINIO=""
  if [[ -f "/etc/SN/dominio.txt" ]]; then
    DOMINIO="$(cat /etc/SN/dominio.txt)"
  fi

  # Verificar swap
  SWAP_INFO=""
  SWAP_TOTAL=$(free -m | awk '/^Swap:/ {print $2}')
  if [[ "$SWAP_TOTAL" -gt 0 ]]; then
    SWAP_USED=$(free -m | awk '/^Swap:/ {print $3}')
    SWAP_FREE=$(free -m | awk '/^Swap:/ {print $4}')
    SWAP_INFO="${Y}${SWAP_TOTAL} MB${W} > Uso: ${Y}${SWAP_USED} MB${W} > Libre: ${G}${SWAP_FREE} MB${N}"
  fi
}

show_banner() {
  clear_screen
  get_system_info
  show_custom_banner

  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}" #se agregqn 6 es[...]
  echo -e "${R}[ ${G}●            SinNombre - VPS Manager v1.0 ●${R} ]${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Sistema: ${G}${DISTRO}${N}"
  echo -e "${R}[${N} ${W}IP Publica: ${Y}${IP_PUBLICA}${N}"
  [[ -n "$DOMINIO" ]] && echo -e "${R}[${N} ${W}Dominio: ${Y}${DOMINIO}${N}"
  echo -e "${R}[${N} ${W}Usuario: ${G}${USUARIO}${N}"
  echo -e "${R}[${N} ${W}Zona Horaria: ${Y}${ZONA_HORARIA}${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Memoria Ram: ${Y}${MEM_TOTAL} MB${W} > Uso: ${Y}${MEM_USADA} MB${W} > Libre: ${G}${MEM_LIBRE} MB${R} ]${N}"
  [[ -n "$SWAP_INFO" ]] && echo -e "${R}[${N} ${W}Memoria Swap: ${SWAP_INFO}${R} ]${N}"
}

get_systemd_unit_by_pid() {
  local pid="$1"
  [[ -n "${pid:-}" ]] || { echo ""; return 0; }
  systemctl show -p Unit --value "$pid" 2>/dev/null || echo ""
}

get_proc_pid_by_port() {
  local port="$1"
  local line proc pid
  line="$(
    ss -H -lntup 2>/dev/null \
    | awk -v re=":${port}\$" '$5 ~ re {print; exit}' \
    || true
  )"
  [[ -n "${line:-}" ]] || { echo "Desconocido|"; return 0; }
  proc="$(echo "$line" | sed -n 's/.*users:(("\([^"]*\)".*/\1/p' || true)"
  pid="$(echo "$line"  | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' || true)"
  [[ -n "${proc:-}" ]] || proc="Desconocido"
  echo "${proc}|${pid}"
}

get_service_type() {
  local proc="$1"
  local unit="$2"
  if [[ -n "${unit:-}" ]]; then
    echo "${unit%.service}"  # Nombre exacto del servicio systemd
  else
    echo "$proc"  # Nombre exacto del proceso
  fi
}

show_services_status() {
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                   SERVICIOS ACTIVOS${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"

  local lines
  lines="$(ss -H -lntup 2>/dev/null || true)"

  declare -A services_ports

  while read -r line; do
    [[ -z "$line" ]] && continue

    local port proc pid unit
    port="$(echo "$line" | awk '{print $5}' | awk -F':' '{print $NF}')"
    [[ -z "$port" || ! "$port" =~ ^[0-9]+$ ]] && continue

    proc="$(echo "$line" | sed -n 's/.*users:(("\([^"]*\)".*/\1/p' || true)"
    pid="$(echo "$line" | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' || true)"
    unit=""
    [[ -n "$pid" ]] && unit="$(systemctl show -p Unit --value "$pid" 2>/dev/null || true)"

    local service
    service="$(get_service_type "$proc" "$unit")"

    if [[ -n "${services_ports[$service]:-}" ]]; then
      if [[ "${services_ports[$service]}" != *"$port"* ]]; then
        services_ports[$service]="${services_ports[$service]}, $port"
      fi
    else
      services_ports[$service]="$port"
    fi
  done <<< "$lines"

  local count="${#services_ports[@]}"
  if [[ "$count" -eq 0 ]]; then
    echo -e "${Y}No se encontraron servicios activos${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo ""
    return 0
  fi

  local keys=("${!services_ports[@]}")
local count=${#keys[@]}
local half=$(( (count + 1) / 2 ))

for ((i = 0; i < half; i++)); do
  # --- COLUMNA 1 ---
  # Calculamos cuánto espacio ocupa el texto sin colores para compensar el alineado
  # Nombre (${C}), Dos puntos (${W}), Puerto (${G})
  printf "${C}%s${W}: ${G}%s${N}" "${keys[$i]}" "${services_ports[${keys[$i]}]}"
  
  # Calculamos el espacio necesario para que la segunda columna no se mueva.
  # Si el nombre + puerto es corto, añadimos espacios manuales.
  actual_len=$((${#keys[$i]} + ${#services_ports[${keys[$i]}]} + 2))
  spacer=$((30 - actual_len))
  if [ $spacer -gt 0 ]; then
    printf "%${spacer}s" " "
  fi

  # --- COLUMNA 2 ---
  if [[ $((i + half)) -lt count ]]; then
    idx_der=$((i + half))
    printf "${C}%s${W}: ${G}%s${N}" "${keys[$idx_der]}" "${services_ports[${keys[$idx_der]}]}"
  fi
  
  echo "" 
done
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

show_system_status() {
  echo -e "${W}                    ESTADO DEL SISTEMA${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Uptime:  ${Y}$(uptime -p | sed 's/up //')${N}"
  echo -e "${R}[${N} ${W}Espacio disco: ${Y}$(df -h / | awk 'NR==2{print $4}') libre${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

show_full_menu() {
  echo -e "${W}                     MENÚ PRINCIPAL${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${Y}1${R}]${N}  ${C}USUARIOS SSH${N}             ${R}[${Y}5${R}]${N}  ${C}BANNER SSH${N}"
  echo -e "${R}[${Y}2${R}]${N}  ${C}USUARIOS V2RAY/XRAY${N}      ${R}[${Y}6${R}]${N}  ${C}ADMINISTRAR PUERTOS${N}"
  echo -e "${R}[${Y}3${R}]${N}  ${C}INSTALADORES${N}             ${R}[${Y}7${R}]${N}  ${C}SPEEDTEST${N}"
  echo -e "${R}[${Y}4${R}]${N}  ${C}HERRAMIENTAS${N}"
  echo -e "${R}─────────────────────────── / / / ──────────────────────────${N}"
  echo -e "${R}[${Y}99${R}]${N}  ${C}REBOOT VPS${N}                ${R}[${Y}100${R}]${N} ${C}DESINSTALAR SCRIPT${N}"
  echo -e "${R}[${Y}101${R}]${N} ${C}ACTUALIZAR SCRIPT${N}         ${R}[${Y}102${R}]${N} ${C}SALIR DE LA VPS${N}"
  echo -e "${R}[${Y}0${R}]${N}  ${C}SALIR${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

show_no_v2ray_menu() {
  echo -e "${W}                     MENÚ PRINCIPAL${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${Y}1${R}]${N}  ${C}USUARIOS SSH${N}             ${R}[${Y}5${R}]${N}  ${C}ADMINISTRAR PUERTOS${N}"
  echo -e "${R}[${Y}2${R}]${N}  ${C}INSTALADORES${N}             ${R}[${Y}6${R}]${N}  ${C}SPEEDTEST${N}"
  echo -e "${R}[${Y}3${R}]${N}  ${C}HERRAMIENTAS${N}"
  echo -e "${R}[${Y}4${R}]${N}  ${C}BANNER SSH${N}"
  echo -e "${R}─────────────────────────── / / / ──────────────────────────${N}"
  echo -e "${R}[${Y}99${R}]${N}  ${C}REBOOT VPS${N}                ${R}[${Y}100${R}]${N} ${C}DESINSTALAR SCRIPT${N}"
  echo -e "${R}[${Y}101${R}]${N} ${C}ACTUALIZAR SCRIPT${N}         ${R}[${Y}102${R}]${N} ${C}SALIR DE LA VPS${N}"
  echo -e "${R}[${Y}0${R}]${N}  ${C}SALIR${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

main_menu() {
  while true; do
    # Verificar si v2ray/xray están instalados (cada vez que se muestra el menú)
    v2ray_installed=false
    if systemctl is-active --quiet v2ray 2>/dev/null || systemctl is-active --quiet xray 2>/dev/null || [[ -f /etc/v2ray/config.json ]] || [[ -f /usr/local/etc/xray/config.json ]]; then
      v2ray_installed=true
    fi

    show_banner
    show_services_status
    show_system_status

    if $v2ray_installed; then
      show_full_menu
      echo ""
      echo -ne "${W}Selecciona una opción: ${G}"
      read -r option
      case "${option:-}" in
        1) run_module "Usuarios/ssh.sh" ;;
        2) run_module "Usuarios/v2ray.sh" ;;
        3) run_module "Protocolos/menu.sh" ;;
        4) run_module "Herramientas/menu.sh" ;;
        5) banner_ssh_menu ;;
        6) run_module "Sistema/puertos.sh" ;;
        7) run_module "Herramientas/speedtest.sh" ;;
        99) reboot_vps ;;
        100) desinstalador_script ;;
        101) update_script ;;
        102) exit_vps ;;
        0) exit_script ; return 0 ;;
        *) invalid_option ;;
      esac
    else
      show_no_v2ray_menu
      echo ""
      echo -ne "${W}Selecciona una opción: ${G}"
      read -r option
      case "${option:-}" in
        1) run_module "Usuarios/ssh.sh" ;;
        2) run_module "Protocolos/menu.sh" ;;
        3) run_module "Herramientas/menu.sh" ;;
        4) banner_ssh_menu ;;
        5) run_module "Sistema/puertos.sh" ;;
        6) run_module "Herramientas/speedtest.sh" ;;
        99) reboot_vps ;;
        100) desinstalador_script ;;
        101) update_script ;;
        102) exit_vps ;;
        0) exit_script ; return 0 ;;
        *) invalid_option ;;
      esac
    fi
  done
}

banner_ssh_menu() {
  run_module "Sistema/banner_ssh.sh"
}

reboot_vps() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}                    REINICIAR VPS${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -ne "${Y}¿Estás seguro que deseas reiniciar el VPS? (s/n): ${N}"
  read -r confirm
  if [[ "${confirm:-}" == "s" || "${confirm:-}" == "S" ]]; then
    echo -e "${Y}El VPS se reiniciará en 10 segundos...${N}"
    sleep 10
    reboot
    exit 0
  fi
}

desinstalador_script() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                  DESINSTALAR COMPLETAMENTE${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"

  echo -e "${Y}¡ATENCIÓN! Esto eliminará:${N}"
  echo -e "${W}- Archivos y carpetas del Script (menu, sn, Herramientas/, Usuarios/, Protocolos/, Sistema/ ...)"
  echo -e "- Servicios systemd instalados por SinNombre (v2ray, xray, stunnel4, squid, etc.)"
  echo -e "- Configuración propia del panel"
  echo -e "${R}Esta acción es irreversible.${N}\n"

  echo -ne "${Y}¿Estás seguro de continuar? (s/n): ${N}"
  read -r confirm
  [[ "${confirm:-}" =~ ^[sS]$ ]] || { echo -e "${Y}Cancelado.${N}"; pause; return; }

  # Detener y eliminar servicios conocidos
  for svc in v2ray xray trojan dropbear stunnel4 squid squid3; do
    if systemctl list-unit-files | grep -q "^$svc.service"; then
      systemctl stop "$svc" 2>/dev/null
      systemctl disable "$svc" 2>/dev/null
      rm -f "/etc/systemd/system/$svc.service" "/lib/systemd/system/$svc.service" 2>/dev/null
    fi
    pkill -f "$svc" 2>/dev/null || true
  done

  systemctl daemon-reload

  # Borrar archivos y directorios instalados por el panel
  script_files=(
    "$ROOT_DIR/menu"
    "$ROOT_DIR/sn"
  )
  script_dirs=(
    "$ROOT_DIR/Herramientas"
    "$ROOT_DIR/Usuarios"
    "$ROOT_DIR/Protocolos"
    "$ROOT_DIR/Sistema"
  )
  for f in "${script_files[@]}"; do
    [ -e "$f" ] && rm -f "$f"
  done

  for d in "${script_dirs[@]}"; do
    [ -d "$d" ] && rm -rf "$d"
  done

  # Eliminar symlinks en /usr/local/bin
  for bin in sn menu; do
    [ -L "/usr/local/bin/$bin" ] && rm -f "/usr/local/bin/$bin"
    [ -f "/usr/local/bin/$bin" ] && rm -f "/usr/local/bin/$bin"
  done

  echo -e "${G}Desinstalación completa.${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}El Script y los servicios añadidos han sido eliminados.${N}"
  echo -e "${W}Puedes cerrar la terminal o reiniciar el VPS.${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  exit 0
}

update_script() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                ACTUALIZAR SCRIPT${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}Descargando la última versión desde GitHub...${N}"
  if wget -O /tmp/menu_new https://raw.githubusercontent.com/SINNOMBRE22/SN/main/menu 2>/dev/null; then
    chmod +x /tmp/menu_new
    cp /tmp/menu_new "$ROOT_DIR/menu"
    chmod +x "$ROOT_DIR/menu"
    echo -e "${G}Script actualizado exitosamente!${N}"
    echo -e "${Y}Reinicia el menú para aplicar cambios.${N}"
  else
    echo -e "${R}Error al descargar la actualización.${N}"
  fi
  pause
}

exit_vps() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}              Saliendo de la sesión SSH...${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  sleep 1
  # Matar el proceso padre para cerrar la sesión SSH
  kill -KILL $PPID 2>/dev/null || exit 0
}

invalid_option() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${B}                   OPCIÓN INVÁLIDA${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  sleep 2
}

exit_script() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}              Saliendo de SinNombre...${N}"
  echo -e "${G}           ¡Gracias por usar SinNombre!${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  exit
}

trap exit_script SIGINT SIGTERM

require_root
main_menu
