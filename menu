#!/bin/bash
set -euo pipefail

# =========================================================
# SinNombre v2.0 - Panel CLI (Ubuntu 22.04+)
# Creador: @SIN_NOMBRE22
# =========================================================

R='\033[0;31m'
G='\033[0;32m'
Y='\033[1;33m'
B='\033[0;34m'
M='\033[0;35m'
C='\033[0;36m'
W='\033[1;37m'
N='\033[0m'
#=====≠===============================================
#Colores del banner
ROJO="\e[31m"
BLANCO="\e[97m"
CYAN="\e[36m"
AMARILLO="\e[33m"
RESET="\e[0m"
#=====================================================
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

run_module() {
  local rel="$1"
  local path="${ROOT_DIR}/${rel}"
  if [[ -f "$path" ]]; then
    bash "$path"
    # Cuando el módulo termina, limpia la pantalla y retorna
    clear_screen
  else
    echo ""
    echo -e "${Y}Módulo no disponible:${N} ${C}${rel}${N}"
    echo -e "${Y}Estado:${N} En desarrollo..."
    pause
  fi
}

clear_screen() { clear; }

pause() {
  echo ""
  read -r -p "Presiona Enter para continuar..."
}

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    clear_screen
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo -e "${Y}Este panel debe ejecutarse como root.${N}"
    echo -e "${W}Usa:${N} ${C}sudo menu${N}  ${W}o${N}  ${C}sudo sn${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    exit 1
  fi
}

show_custom_banner() {
  if command -v toilet &>/dev/null; then
    echo -e "\e[31m$(toilet -f slant -F metal "SinNombre")\e[0m"
  fi
}

get_system_info() {
  if [[ -f /etc/os-release ]]; then
    . /etc/os-release
    DISTRO="${PRETTY_NAME:-$(uname -rs)}"
  else
    DISTRO="$(uname -rs)"
  fi

  IP_PUBLICA="$(
    curl -fsS --max-time 2 ifconfig.me 2>/dev/null \
    || curl -fsS --max-time 2 ipinfo.io/ip 2>/dev/null \
    || echo "No disponible"
  )"

  USUARIO="$(whoami)"
  ZONA_HORARIA="$(timedatectl 2>/dev/null | awk -F': ' '/Time zone/ {print $2}' | awk '{print $1}' || date +%Z)"

  read MEM_TOTAL MEM_USADA MEM_LIBRE <<< $(free -m | awk '/^Mem:/ {print $2, $3, $7}')

  # Verificar dominio
  DOMINIO=""
  if [[ -f "/etc/SN/dominio.txt" ]]; then
    DOMINIO="$(cat /etc/SN/dominio.txt)"
  fi

  # Verificar swap
  SWAP_INFO=""
  SWAP_TOTAL=$(free -m | awk '/^Swap:/ {print $2}')
  if [[ "$SWAP_TOTAL" -gt 0 ]]; then
    SWAP_USED=$(free -m | awk '/^Swap:/ {print $3}')
    SWAP_FREE=$(free -m | awk '/^Swap:/ {print $4}')
    SWAP_INFO="${Y}${SWAP_TOTAL} MB${W} > Uso: ${Y}${SWAP_USED} MB${W} > Libre: ${G}${SWAP_FREE} MB${N}"
  fi
}

show_banner() {
  clear_screen
  get_system_info
  show_custom_banner

  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}" #se agregqn 6 es[...]
  echo -e "${R}[ ${G}●            SinNombre - VPS Manager v1.0 ●${R} ]${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Sistema: ${G}${DISTRO}${N}"
  echo -e "${R}[${N} ${W}IP Publica: ${Y}${IP_PUBLICA}${N}"
  [[ -n "$DOMINIO" ]] && echo -e "${R}[${N} ${W}Dominio: ${Y}${DOMINIO}${N}"
  echo -e "${R}[${N} ${W}Usuario: ${G}${USUARIO}${N}"
  echo -e "${R}[${N} ${W}Zona Horaria: ${Y}${ZONA_HORARIA}${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Memoria Ram: ${Y}${MEM_TOTAL} MB${W} > Uso: ${Y}${MEM_USADA} MB${W} > Libre: ${G}${MEM_LIBRE} MB${R} ]${N}"
  [[ -n "$SWAP_INFO" ]] && echo -e "${R}[${N} ${W}Memoria Swap: ${SWAP_INFO}${R} ]${N}"
}

get_systemd_unit_by_pid() {
  local pid="$1"
  [[ -n "${pid:-}" ]] || { echo ""; return 0; }
  systemctl show -p Unit --value "$pid" 2>/dev/null || echo ""
}

get_proc_pid_by_port() {
  local port="$1"
  local line proc pid
  line="$(
    ss -H -lntup 2>/dev/null \
    | awk -v re=":${port}\$" '$5 ~ re {print; exit}' \
    || true
  )"
  [[ -n "${line:-}" ]] || { echo "Desconocido|"; return 0; }
  proc="$(echo "$line" | sed -n 's/.*users:(("\([^"]*\)".*/\1/p' || true)"
  pid="$(echo "$line"  | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' || true)"
  [[ -n "${proc:-}" ]] || proc="Desconocido"
  echo "${proc}|${pid}"
}

get_service_type() {
  local proc="$1"
  local unit="$2"
  if [[ -n "${unit:-}" ]]; then
    case "$unit" in
      ssh.service|sshd.service) echo "SSH" ;;
      dropbear.service) echo "DROPBEAR" ;;
      stunnel4.service) echo "STUNNEL" ;;
      squid.service|squid3.service) echo "SQUID" ;;
      python.[0-9]*.service) echo "SOCKS(PY)" ;;
      xray.service|v2ray.service) echo "PROXY" ;;
      nginx.service|apache2.service) echo "WEB" ;;
      *) echo "DESCONOCIDO" ;;
    esac
    return 0
  fi

  case "$proc" in
    sshd|ssh) echo "SSH" ;;
    dropbear) echo "DROPBEAR" ;;
    stunnel4|stunnel) echo "STUNNEL" ;;
    squid|squid3) echo "SQUID" ;;
    python|python2|python2.7|python3|gunicorn|uwsgi) echo "PYTHON" ;;
    nginx|apache2|httpd) echo "WEB" ;;
    v2ray|xray|trojan) echo "PROXY" ;;
    named|bind9) echo "DNS" ;;
    dhclient|systemd-networkd|NetworkManager) echo "DHCP" ;;
    *) echo "DESCONOCIDO" ;;
  esac
}

show_services_status() {
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                   SERVICIOS ACTIVOS${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"

  local listening_ports
  listening_ports="$(ss -H -lntup 2>/dev/null | awk '{print $5}' | awk -F':' '{print $NF}' | sort -n | uniq || true)"

  if [[ -z "${listening_ports:-}" ]]; then
    echo -e "${Y}No se encontraron servicios activos${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo ""
    return 0
  fi

  declare -a ports_array=()
  declare -a services_array=()

  while read -r port; do
    [[ -n "${port:-}" ]] || continue
    [[ "${port}" =~ ^[0-9]+$ ]] || continue
    local pp proc pid unit service
    pp="$(get_proc_pid_by_port "$port")"
    proc="${pp%%|*}"
    pid="${pp#*|}"
    unit=""
    [[ -n "${pid:-}" ]] && unit="$(get_systemd_unit_by_pid "$pid")"
    service="$(get_service_type "$proc" "$unit")"
    ports_array+=("$port")
    services_array+=("$service")
  done <<< "$listening_ports"

  local count="${#ports_array[@]}"
  if [[ "$count" -eq 0 ]]; then
    echo -e "${Y}No se encontraron servicios activos${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo ""
    return 0
  fi

  local half=$(( (count + 1) / 2 ))
  for ((i = 0; i < half; i++)); do
    if [[ $i -lt $count ]]; then
      printf "${C}%-12s${W}: ${G}%-7s${N}" "${services_array[$i]}" "${ports_array[$i]}"
    fi
    printf "  "
    if [[ $((i + half)) -lt $count ]]; then
      printf "${C}%-12s${W}: ${G}%-7s${N}" "${services_array[$((i + half))]}" "${ports_array[$((i + half))]}"
    fi
    echo ""
  done
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

show_system_status() {
  echo -e "${W}                    ESTADO DEL SISTEMA${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${R}[${N} ${W}Uptime:  ${Y}$(uptime -p | sed 's/up //')${N}"
  echo -e "${R}[${N} ${W}Espacio disco: ${Y}$(df -h / | awk 'NR==2{print $4}') libre${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
}

main_menu() {
  while true; do
    show_banner
    show_services_status
    show_system_status

    echo -e "${W}                     MENÚ PRINCIPAL${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo -e "${R}[${Y}1${R}]${N}  ${C}USUARIOS SSH${N}             ${R}[${Y}5${R}]${N}  ${C}BANNER SSH${N}"
    echo -e "${R}[${Y}2${R}]${N}  ${C}USUARIOS V2RAY/XRAY${N}      ${R}[${Y}6${R}]${N}  ${C}ADMINISTRAR PUERTOS${N}"
    echo -e "${R}[${Y}3${R}]${N}  ${C}INSTALADORES${N}             ${R}[${Y}7${R}]${N}  ${C}SPEEDTEST${N}"
    echo -e "${R}[${Y}4${R}]${N}  ${C}HERRAMIENTAS${N}             ${R}[${Y}99${R}]${N} ${C}REBOOT VPS${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo -e "${R}[${Y}100${R}]${N} ${C}DESINSTALAR SCRIPT${N}       ${R}[${Y}0${R}]${N}  ${C}SALIR${N}"
    echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
    echo ""
    echo -ne "${W}Selecciona una opción: ${G}"
    read -r option

    case "${option:-}" in
      1) run_module "Usuarios/ssh.sh" ;;
      2) run_module "Usuarios/v2ray.sh" ;;
      3) run_module "Protocolos/menu.sh" ;;
      4) run_module "Herramientas/menu.sh" ;;
      5) banner_ssh_menu ;;
      6) run_module "Sistema/puertos.sh" ;;
      7) run_module "Herramientas/speedtest.sh" ;;
      99) reboot_vps ;;
      100) desinstalador_script ;;
      0) exit_script
        return 0 # Por si hay un error, salimos del ciclo
        ;;
      *)
        invalid_option
        ;;
    esac
  done
}

banner_ssh_menu() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                PERSONALIZAR BANNER SSH${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}En desarrollo...${N}"
  pause
}

reboot_vps() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}                    REINICIAR VPS${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -ne "${Y}¿Estás seguro que deseas reiniciar el VPS? (s/n): ${N}"
  read -r confirm
  if [[ "${confirm:-}" == "s" || "${confirm:-}" == "S" ]]; then
    echo -e "${Y}El VPS se reiniciará en 10 segundos...${N}"
    sleep 10
    reboot
    exit 0
  fi
}

desinstalador_script() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${W}                  DESINSTALAR COMPLETAMENTE${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"

  echo -e "${Y}¡ATENCIÓN! Esto eliminará:${N}"
  echo -e "${W}- Archivos y carpetas del Script (menu, sn, Herramientas/, Usuarios/, Protocolos/, Sistema/ ...)"
  echo -e "- Servicios systemd instalados por SinNombre (v2ray, xray, stunnel4, squid, etc.)"
  echo -e "- Configuración propia del panel"
  echo -e "${R}Esta acción es irreversible.${N}\n"

  echo -ne "${Y}¿Estás seguro de continuar? (s/n): ${N}"
  read -r confirm
  [[ "${confirm:-}" =~ ^[sS]$ ]] || { echo -e "${Y}Cancelado.${N}"; pause; return; }

  # Detener y eliminar servicios conocidos
  for svc in v2ray xray trojan dropbear stunnel4 squid squid3; do
    if systemctl list-unit-files | grep -q "^$svc.service"; then
      systemctl stop "$svc" 2>/dev/null
      systemctl disable "$svc" 2>/dev/null
      rm -f "/etc/systemd/system/$svc.service" "/lib/systemd/system/$svc.service" 2>/dev/null
    fi
    pkill -f "$svc" 2>/dev/null || true
  done

  systemctl daemon-reload

  # Borrar archivos y directorios instalados por el panel
  script_files=(
    "$ROOT_DIR/menu"
    "$ROOT_DIR/sn"
  )
  script_dirs=(
    "$ROOT_DIR/Herramientas"
    "$ROOT_DIR/Usuarios"
    "$ROOT_DIR/Protocolos"
    "$ROOT_DIR/Sistema"
  )
  for f in "${script_files[@]}"; do
    [ -e "$f" ] && rm -f "$f"
  done

  for d in "${script_dirs[@]}"; do
    [ -d "$d" ] && rm -rf "$d"
  done

  # Eliminar symlinks en /usr/local/bin
  for bin in sn menu; do
    [ -L "/usr/local/bin/$bin" ] && rm -f "/usr/local/bin/$bin"
    [ -f "/usr/local/bin/$bin" ] && rm -f "/usr/local/bin/$bin"
  done

  echo -e "${G}Desinstalación completa.${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}El Script y los servicios añadidos han sido eliminados.${N}"
  echo -e "${W}Puedes cerrar la terminal o reiniciar el VPS.${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  exit 0
}

invalid_option() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${B}                   OPCIÓN INVÁLIDA${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  sleep 2
}

exit_script() {
  clear_screen
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  echo -e "${Y}              Saliendo de SinNombre...${N}"
  echo -e "${G}           ¡Gracias por usar SinNombre!${N}"
  echo -e "${R}══════════════════════════ / / / ══════════════════════════${N}"
  exit 0
}

trap exit_script SIGINT SIGTERM

require_root
main_menu
